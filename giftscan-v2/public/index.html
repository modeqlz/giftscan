<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GiftScan</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<!-- Lottie –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ TGS –∞–Ω–∏–º–∞—Ü–∏–π (—Ç–µ —Å–∞–º—ã–µ 3D –∏–∫–æ–Ω–∫–∏) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
  :root {
    --bg: #080810;
    --surface: #0f0f1a;
    --surface2: #16162a;
    --surface3: #1e1e32;
    --border: #ffffff0d;
    --border2: #ffffff18;
    --text: #ededf8;
    --muted: #5a5a78;
    --green: #3ddc84;
    --red: #ff6b6b;
    --yellow: #f5c542;
    --blue: #5b9cf6;
    --purple: #9d78f8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 48px 48px;
    z-index: 0;
    pointer-events: none;
  }

  .glow {
    position: fixed;
    top: -200px; left: 50%;
    transform: translateX(-50%);
    width: 600px; height: 500px;
    background: radial-gradient(ellipse, #5b3ff318 0%, transparent 65%);
    z-index: 0; pointer-events: none;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 48px 20px 100px;
  }

  /* HEADER */
  header {
    text-align: center;
    margin-bottom: 40px;
    animation: fadeDown 0.6s ease;
  }

  .logo-row {
    display: flex; align-items: center; justify-content: center;
    gap: 10px; margin-bottom: 16px;
  }

  .logo-icon {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, #5b3ff3, #9d78f8);
    border-radius: 11px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }

  .logo-text {
    font-size: 24px; font-weight: 800; letter-spacing: -0.02em;
    background: linear-gradient(135deg, #fff 30%, #9d78f8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  h1 {
    font-size: clamp(28px, 6vw, 44px);
    font-weight: 800; letter-spacing: -0.025em; line-height: 1.1;
    margin-bottom: 10px;
    background: linear-gradient(160deg, #fff 0%, #9d9dcc);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle { color: var(--muted); font-size: 14px; line-height: 1.6; }

  /* SEARCH */
  .search-box {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 16px;
    padding: 6px 6px 6px 18px;
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    animation: fadeUp 0.6s ease 0.1s both;
  }

  .search-box:focus-within {
    border-color: #5b3ff340;
    box-shadow: 0 0 0 3px #5b3ff312;
  }

  input[type="text"] {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: 'Syne', sans-serif;
    font-size: 15px; padding: 10px 0;
  }

  input::placeholder { color: var(--muted); }

  .search-btn {
    background: linear-gradient(135deg, #5b3ff3, #7c5bf8);
    color: #fff; border: none; border-radius: 11px;
    padding: 12px 22px;
    font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all 0.18s; white-space: nowrap;
  }

  .search-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 20px #5b3ff335;
  }

  /* CHIPS */
  .chips-label {
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase;
    margin-bottom: 10px;
    animation: fadeUp 0.6s ease 0.15s both;
  }

  .chips {
    display: flex; flex-wrap: wrap; gap: 7px;
    margin-bottom: 32px;
    animation: fadeUp 0.6s ease 0.2s both;
  }

  .chip {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 100px; padding: 6px 13px;
    font-size: 13px; color: var(--muted);
    cursor: pointer; transition: all 0.18s;
    display: flex; align-items: center; gap: 6px;
  }

  /* –ú–∞–ª–µ–Ω—å–∫–∏–π Lottie –≤ —á–∏–ø–µ */
  .chip-lottie {
    width: 22px; height: 22px; flex-shrink: 0;
  }

  .chip:hover {
    background: var(--surface2); border-color: #ffffff28;
    color: var(--text); transform: translateY(-1px);
  }

  .chip.active {
    background: var(--surface3); border-color: #5b3ff345; color: #c8c8ff;
  }

  /* RESULT CARD */
  .card {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 20px; overflow: hidden;
    margin-bottom: 14px; animation: fadeUp 0.35s ease;
  }

  .card-header {
    padding: 22px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 18px;
  }

  /* ‚îÄ‚îÄ –ì–õ–ê–í–ù–ê–Ø –ó–í–ï–ó–î–ê: –ë–æ–ª—å—à–æ–π Lottie –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚îÄ‚îÄ */
  .gift-lottie-wrap {
    width: 90px; height: 90px;
    border-radius: 20px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }

  .gift-lottie-wrap .lottie-player {
    width: 100%; height: 100%;
  }

  /* Fallback –µ—Å–ª–∏ TGS –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è */
  .gift-lottie-wrap .fallback {
    font-size: 40px;
    position: absolute;
  }

  .gift-lottie-wrap .img-preview {
    width: 100%; height: 100%;
    object-fit: cover; border-radius: 20px;
    position: absolute;
  }

  /* Shimmer –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
  .lottie-loading {
    position: absolute; inset: 0;
    background: linear-gradient(90deg, var(--surface2) 25%, #ffffff06 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
    border-radius: 20px;
  }

  .gift-info { flex: 1; min-width: 0; }

  .gift-name {
    font-size: 19px; font-weight: 700; letter-spacing: -0.01em;
    margin-bottom: 6px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .gift-tags { display: flex; gap: 6px; flex-wrap: wrap; }

  .tag {
    font-family: 'DM Mono', monospace; font-size: 10px;
    padding: 3px 8px; border-radius: 100px;
    letter-spacing: 0.06em; text-transform: uppercase;
  }

  .tag-blue { background: #5b9cf610; border: 1px solid #5b9cf620; color: var(--blue); }
  .tag-yellow { background: #f5c54212; border: 1px solid #f5c54228; color: var(--yellow); }
  .tag-muted { background: #ffffff08; border: 1px solid var(--border2); color: var(--muted); }
  .tag-green { background: #3ddc8412; border: 1px solid #3ddc8428; color: var(--green); }

  .diff-badge {
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 12px; padding: 10px 14px;
    text-align: center; flex-shrink: 0;
  }

  .diff-pct {
    font-family: 'DM Mono', monospace; font-size: 20px;
    font-weight: 500; color: var(--yellow); display: block;
  }

  .diff-lbl {
    font-family: 'DM Mono', monospace; font-size: 9px;
    color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase;
  }

  /* PLATFORMS */
  .platforms { display: grid; grid-template-columns: 1fr 1fr; }

  .platform { padding: 20px; position: relative; }
  .platform:first-child { border-right: 1px solid var(--border); }

  .cheaper-pill {
    position: absolute; top: 13px; right: 13px;
    background: #3ddc8415; border: 1px solid #3ddc8428;
    border-radius: 100px; padding: 3px 9px;
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--green); letter-spacing: 0.06em;
  }

  .platform-head {
    display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
  }

  .platform-ico {
    width: 22px; height: 22px; border-radius: 6px;
    background: var(--surface3);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
  }

  .platform-nm {
    font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 0.1em; color: var(--muted); text-transform: uppercase;
  }

  .price-big {
    font-size: 28px; font-weight: 800; letter-spacing: -0.02em;
    line-height: 1; margin-bottom: 5px;
  }

  .price-big .unit {
    font-size: 13px; font-weight: 600; color: var(--muted); margin-left: 4px;
  }

  .price-usd {
    font-family: 'DM Mono', monospace; font-size: 12px;
    color: var(--muted); margin-bottom: 14px;
  }

  .fee-tag {
    display: inline-block; background: var(--surface2);
    border-radius: 6px; padding: 5px 10px;
    font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--muted); margin-bottom: 14px;
  }

  .open-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 10px; padding: 10px;
    font-size: 13px; font-weight: 600; color: var(--text);
    text-decoration: none; cursor: pointer;
    transition: all 0.18s; width: 100%;
  }

  .open-btn:hover {
    background: var(--surface3); border-color: #ffffff28;
    transform: translateY(-1px);
  }

  /* ARB */
  .arb-card {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 20px; padding: 22px;
    margin-bottom: 14px; animation: fadeUp 0.35s ease 0.08s both;
  }

  .section-title {
    font-family: 'DM Mono', monospace; font-size: 10px;
    letter-spacing: 0.14em; color: var(--muted);
    text-transform: uppercase; margin-bottom: 16px;
  }

  .arb-rows { display: flex; flex-direction: column; gap: 10px; }

  .arb-row {
    display: flex; align-items: center; justify-content: space-between;
  }

  .arb-row-l { font-size: 14px; color: var(--muted); }

  .arb-val { font-family: 'DM Mono', monospace; font-size: 14px; }
  .arb-val.profit { color: var(--green); }
  .arb-val.loss   { color: var(--red); }
  .arb-val.neutral { color: var(--text); }

  hr.div {
    border: none; border-top: 1px solid var(--border); margin: 12px 0;
  }

  .arb-result {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface2); border-radius: 12px; padding: 14px 16px;
  }

  .arb-result-l { font-size: 14px; font-weight: 600; }

  .arb-result-v {
    font-family: 'DM Mono', monospace; font-size: 16px; font-weight: 600;
  }

  /* LOADER */
  .loader-wrap {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 20px; padding: 48px; text-align: center;
  }

  .loader-ring {
    width: 36px; height: 36px;
    border: 2px solid var(--border2); border-top-color: var(--purple);
    border-radius: 50%; animation: spin 0.8s linear infinite;
    margin: 0 auto 14px;
  }

  .loader-text {
    font-family: 'DM Mono', monospace; font-size: 13px; color: var(--muted);
  }

  /* EMPTY */
  .empty { text-align: center; padding: 60px 24px; animation: fadeUp 0.4s ease; }
  .empty-ico { font-size: 42px; margin-bottom: 14px; opacity: 0.3; }
  .empty-title { font-size: 17px; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
  .empty-sub { font-size: 13px; color: var(--muted); opacity: 0.5; }

  /* HOW IT WORKS */
  .how-card {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 16px; padding: 18px 20px;
    margin-bottom: 12px;
    animation: fadeUp 0.6s ease 0.3s both;
  }

  .how-title {
    font-family: 'DM Mono', monospace; font-size: 10px;
    letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase;
    margin-bottom: 12px;
  }

  .how-row {
    display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px;
  }

  .how-row:last-child { margin-bottom: 0; }

  .how-num {
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--surface3); flex-shrink: 0;
    font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted);
    display: flex; align-items: center; justify-content: center;
  }

  .how-text { font-size: 13px; color: var(--muted); line-height: 1.5; padding-top: 1px; }
  .how-text strong { color: var(--text); }

  /* ANIMS */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-14px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(14px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  @media (max-width: 500px) {
    .platforms { grid-template-columns: 1fr; }
    .platform:first-child { border-right: none; border-bottom: 1px solid var(--border); }
  }
</style>
</head>
<body>
<div class="glow"></div>

<div class="container">

  <header>
    <div class="logo-row">
      <div class="logo-icon">üéÅ</div>
      <div class="logo-text">GiftScan</div>
    </div>
    <h1>–°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω—ã –ø–æ–¥–∞—Ä–∫–æ–≤<br>–∑–∞ —Å–µ–∫—É–Ω–¥—É</h1>
    <p class="subtitle">Portals vs Getgems ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ 3D –∞–Ω–∏–º–∞—Ü–∏–∏</p>
  </header>

  <div class="search-box">
    <span style="color:var(--muted);font-size:16px">üîç</span>
    <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞..." autocomplete="off">
    <button class="search-btn" onclick="handleSearch()">–ù–∞–π—Ç–∏</button>
  </div>

  <div class="chips-label">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</div>
  <div class="chips" id="chips"></div>

  <div id="result"></div>

  <div class="how-card">
    <div class="how-title">‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç 3D –∞–Ω–∏–º–∞—Ü–∏—è</div>
    <div class="how-row">
      <div class="how-num">1</div>
      <div class="how-text"><strong>–ë—ç–∫–µ–Ω–¥</strong> –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç .tgs —Ñ–∞–π–ª –ø–æ–¥–∞—Ä–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API</div>
    </div>
    <div class="how-row">
      <div class="how-num">2</div>
      <div class="how-text"><strong>Lottie.js</strong> —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
    </div>
    <div class="how-row">
      <div class="how-num">3</div>
      <div class="how-text"><strong>Getgems GraphQL</strong> –æ—Ç–¥–∞—ë—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã floor price</div>
    </div>
    <div class="how-row">
      <div class="how-num">4</div>
      <div class="how-text">–ù—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ <strong>file_id</strong> —Å—Ç–∏–∫–µ—Ä–æ–≤ –≤ server.js</div>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ –ö–û–ù–§–ò–ì ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —ç—Ç–æ URL —Ç–≤–æ–µ–≥–æ Render —Å–µ—Ä–≤–µ—Ä–∞
const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:3000'
  : ''; // –Ω–∞ Render ‚Äî —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω

const TON_USD = 3.95;

// Fragment CDN: https://fragment.com/file/gifts/[giftname]/thumb.webp
// –ö–∞—Ä—Ç–∏–Ω–∫–∏ —Ä–µ–∞–ª—å–Ω—ã–µ 3D ‚Äî –ø—É–±–ª–∏—á–Ω—ã–µ, –±–µ–∑ —Ç–æ–∫–µ–Ω–∞!
const GIFTS = [
  { name: 'Plush Pepe',       emoji: 'üê∏', supply: 1000,   rare: true,  slug: 'plushpepe' },
  { name: 'Jelly Bunny',      emoji: 'üê∞', supply: 10000,  rare: false, slug: 'jellybunny' },
  { name: 'Santa Hat',        emoji: 'üéÖ', supply: 65000,  rare: false, slug: 'santahat' },
  { name: 'Homemade Cake',    emoji: 'üéÇ', supply: 10000,  rare: false, slug: 'homemadecake' },
  { name: 'Spiced Wine',      emoji: 'üç∑', supply: 8000,   rare: false, slug: 'spicedwine' },
  { name: 'Signet Ring',      emoji: 'üíç', supply: 5000,   rare: true,  slug: 'signetring' },
  { name: "Durov's Cap",      emoji: 'üß¢', supply: 1000,   rare: true,  slug: 'durovscap' },
  { name: 'Evil Eye',         emoji: 'üßø', supply: 120000, rare: false, slug: 'evileye' },
  { name: 'Swiss Watch',      emoji: '‚åö', supply: 3000,   rare: true,  slug: 'swisswatch' },
  { name: 'Skull Flower',     emoji: 'üíÄ', supply: 10000,  rare: false, slug: 'skullflower' },
  { name: 'Precious Peach',   emoji: 'üçë', supply: 10000,  rare: false, slug: 'preciouspeach' },
  { name: 'Magic Potion',     emoji: 'üß™', supply: 10000,  rare: false, slug: 'magicpotion' },
  { name: 'Kissed Frog',      emoji: 'üê∏', supply: 10000,  rare: false, slug: 'kissedfrog' },
  { name: 'Toy Bear',         emoji: 'üß∏', supply: 10000,  rare: false, slug: 'toybear' },
  { name: 'Eternal Rose',     emoji: 'üåπ', supply: 10000,  rare: false, slug: 'eternalrose' },
  { name: 'Vintage Cigar',    emoji: 'üö¨', supply: 5000,   rare: false, slug: 'vintagecigar' },
];

// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é 3D –∫–∞—Ä—Ç–∏–Ω–∫—É —Å Fragment CDN
function getGiftImageUrl(slug) {
  return `https://fragment.com/file/gifts/${slug}/thumb.webp`;
}

// ‚îÄ‚îÄ LOTTIE –ó–ê–ì–†–£–ó–ß–ò–ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLottie(container, giftName) {
  try {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º TGS —Ñ–∞–π–ª —Å –Ω–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞
    const response = await fetch(`${API_BASE}/api/gift-sticker/${encodeURIComponent(giftName)}`);

    if (!response.ok) throw new Error('No sticker');

    const arrayBuffer = await response.arrayBuffer();

    // TGS = gzip-—Å–∂–∞—Ç—ã–π JSON Lottie
    // –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ DecompressionStream (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö)
    const ds = new DecompressionStream('gzip');
    const writer = ds.writable.getWriter();
    writer.write(new Uint8Array(arrayBuffer));
    writer.close();

    const decompressed = await new Response(ds.readable).arrayBuffer();
    const animData = JSON.parse(new TextDecoder().decode(decompressed));

    // –£–±–∏—Ä–∞–µ–º shimmer
    const shimmer = container.querySelector('.lottie-loading');
    if (shimmer) shimmer.remove();

    // –ó–∞–ø—É—Å–∫–∞–µ–º Lottie
    lottie.loadAnimation({
      container: container.querySelector('.lottie-player'),
      animType: 'canvas',
      loop: true,
      autoplay: true,
      animationData: animData,
    });

  } catch (e) {
    // Fallback ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º emoji
    const shimmer = container.querySelector('.lottie-loading');
    if (shimmer) shimmer.remove();
    const player = container.querySelector('.lottie-player');
    if (player) player.style.display = 'none';
    const fallback = container.querySelector('.fallback');
    if (fallback) fallback.style.display = 'flex';
  }
}

// ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderChips() {
  const container = document.getElementById('chips');
  GIFTS.forEach(gift => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.name = gift.name;
    const imgUrl = getGiftImageUrl(gift.slug);
    chip.innerHTML = `
      <img src="${imgUrl}" 
           style="width:22px;height:22px;object-fit:cover;border-radius:4px;flex-shrink:0" 
           onerror="this.outerHTML='<span>${gift.emoji}</span>'"
      >
      <span>${gift.name}</span>`;
    chip.onclick = () => {
      document.getElementById('searchInput').value = gift.name;
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      handleSearch();
    };
    container.appendChild(chip);
  });
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function handleSearch() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return;

  const gift = GIFTS.find(g => g.name.toLowerCase().includes(query.toLowerCase()));
  if (!gift) {
    document.getElementById('result').innerHTML = `
      <div class="empty">
        <div class="empty-ico">üîç</div>
        <div class="empty-title">–ü–æ–¥–∞—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
        <div class="empty-sub">¬´${query}¬ª ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
      </div>`;
    return;
  }

  showLoader();

  try {
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ü–µ–Ω—ã —Å –Ω–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–æ–Ω –∏–¥—ë—Ç –Ω–∞ Getgems)
    const res = await fetch(`${API_BASE}/api/prices/${encodeURIComponent(gift.name)}`);
    const data = await res.json();

    let getgemsPrice = data.getgems;
    let portalsPrice = data.portals;
    let imageUrl = data.imageUrl;

    // Fallback –Ω–∞ demo –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    if (!getgemsPrice) {
      const mock = mockPrices(gift.name, gift.rare);
      getgemsPrice = mock.getgems;
      portalsPrice = mock.portals;
    }

    renderResult(gift, getgemsPrice, portalsPrice, imageUrl);

  } catch(e) {
    const mock = mockPrices(gift.name, gift.rare);
    renderResult(gift, mock.getgems, mock.portals, null);
  }
}

// ‚îÄ‚îÄ MOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mockPrices(name, rare) {
  const s = name.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
  const base = rare ? 15 + (s % 180) : 2 + (s % 25);
  const v = 0.06 + (s % 12) / 100;
  return {
    getgems: parseFloat(base.toFixed(2)),
    portals: parseFloat((base * (s % 2 === 0 ? 1 + v : 1 - v * 0.5)).toFixed(2))
  };
}

// ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoader() {
  document.getElementById('result').innerHTML = `
    <div class="loader-wrap">
      <div class="loader-ring"></div>
      <div class="loader-text">–ó–∞–≥—Ä—É–∂–∞—é –∞–Ω–∏–º–∞—Ü–∏—é –∏ —Ü–µ–Ω—ã...</div>
    </div>`;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResult(gift, getgemsP, portalsP, imgUrl) {
  const cheaper = getgemsP <= portalsP ? 'getgems' : 'portals';
  const diff = Math.abs(portalsP - getgemsP);
  const diffPct = ((diff / Math.max(portalsP, getgemsP)) * 100).toFixed(1);
  const ggUsd = (getgemsP * TON_USD).toFixed(2);
  const ptUsd = (portalsP * TON_USD).toFixed(2);
  const buyP = Math.min(getgemsP, portalsP);
  const sellP = Math.max(getgemsP, portalsP);
  const fee = sellP * 0.05;
  const profit = sellP - buyP - fee;
  const profitUsd = (profit * TON_USD).toFixed(2);
  const isProfit = profit > 0;

  // –†–µ–∞–ª—å–Ω–∞—è 3D –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å Fragment CDN
  const imgUrl = getGiftImageUrl(gift.slug);
  const thumbHtml = `
    <div class="gift-lottie-wrap" id="giftThumb">
      <div class="lottie-loading" id="imgLoader"></div>
      <img 
        src="${imgUrl}"
        alt="${gift.name}"
        style="width:100%;height:100%;object-fit:cover;border-radius:20px;position:absolute;display:none"
        id="giftImg"
        onload="this.style.display='block'; document.getElementById('imgLoader').style.display='none';"
        onerror="this.style.display='none'; document.getElementById('imgLoader').style.display='none'; document.getElementById('giftFallback').style.display='flex';"
      >
      <div class="fallback" id="giftFallback" style="display:none">${gift.emoji}</div>
    </div>
  `;

  document.getElementById('result').innerHTML = `
    <div class="card">
      <div class="card-header">
        ${thumbHtml}
        <div class="gift-info">
          <div class="gift-name">${gift.name}</div>
          <div class="gift-tags">
            <span class="tag tag-blue">Supply ${gift.supply.toLocaleString()}</span>
            ${gift.rare
              ? '<span class="tag tag-yellow">üî• Rare</span>'
              : '<span class="tag tag-muted">Common</span>'}
          </div>
        </div>
        <div class="diff-badge">
          <span class="diff-pct">${diffPct}%</span>
          <span class="diff-lbl">—Ä–∞–∑–Ω–∏—Ü–∞</span>
        </div>
      </div>

      <div class="platforms">
        <div class="platform">
          ${cheaper === 'getgems' ? '<div class="cheaper-pill">‚úì –î–µ—à–µ–≤–ª–µ</div>' : ''}
          <div class="platform-head">
            <div class="platform-ico">üíé</div>
            <span class="platform-nm">Getgems</span>
          </div>
          <div class="price-big">${getgemsP}<span class="unit">TON</span></div>
          <div class="price-usd">‚âà $${ggUsd}</div>
          <div class="fee-tag">–ö–æ–º–∏—Å—Å–∏—è 5%</div>
          <a class="open-btn" href="https://getgems.io" target="_blank">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a>
        </div>

        <div class="platform">
          ${cheaper === 'portals' ? '<div class="cheaper-pill">‚úì –î–µ—à–µ–≤–ª–µ</div>' : ''}
          <div class="platform-head">
            <div class="platform-ico">üåê</div>
            <span class="platform-nm">Portals</span>
          </div>
          <div class="price-big">${portalsP}<span class="unit">TON</span></div>
          <div class="price-usd">‚âà $${ptUsd}</div>
          <div class="fee-tag">–ö–æ–º–∏—Å—Å–∏—è ~3%</div>
          <a class="open-btn" href="https://t.me/portals" target="_blank">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a>
        </div>
      </div>
    </div>

    <div class="arb-card">
      <div class="section-title">üìä –ê—Ä–±–∏—Ç—Ä–∞–∂ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
      <div class="arb-rows">
        <div class="arb-row">
          <span class="arb-row-l">–ü–æ–∫—É–ø–∫–∞ (${cheaper === 'getgems' ? 'Getgems' : 'Portals'})</span>
          <span class="arb-val neutral">${buyP.toFixed(2)} TON</span>
        </div>
        <div class="arb-row">
          <span class="arb-row-l">–ü—Ä–æ–¥–∞–∂–∞ (${cheaper === 'getgems' ? 'Portals' : 'Getgems'})</span>
          <span class="arb-val neutral">${sellP.toFixed(2)} TON</span>
        </div>
        <div class="arb-row">
          <span class="arb-row-l">–ö–æ–º–∏—Å—Å–∏—è (5%)</span>
          <span class="arb-val loss">‚àí${fee.toFixed(2)} TON</span>
        </div>
      </div>
      <hr class="div">
      <div class="arb-result">
        <span class="arb-result-l">–ü—Ä–∏–±—ã–ª—å</span>
        <span class="arb-result-v ${isProfit ? 'profit' : 'loss'}">
          ${isProfit ? '+' : ''}${profit.toFixed(2)} TON ‚âà $${profitUsd}
        </span>
      </div>
    </div>
  `;

  // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ img onload
}

// ‚îÄ‚îÄ ENTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleSearch();
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
renderChips();
</script>
</body>
</html>
